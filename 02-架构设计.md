# 新闻热点聚合系统 - 架构设计

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Next.js App Router (前端)                    │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │  │
│  │  │ 仪表板页面    │  │ 新闻列表页   │  │ 配置管理页   │ │  │
│  │  │ - 数据概览    │  │ - 新闻展示   │  │ - 关键词配置 │ │  │
│  │  │ - 图表分析    │  │ - 筛选排序   │  │ - 通知配置   │ │  │
│  │  │ - 实时更新    │  │ - 详情查看   │  │ - 系统设置   │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘ │  │
│  │  ┌──────────────┐  ┌──────────────┐                    │  │
│  │  │ 数据分析页    │  │ 历史查询页   │                    │  │
│  │  │ - 趋势分析    │  │ - 日期筛选   │                    │  │
│  │  │ - 话题追踪    │  │ - 平台筛选   │                    │  │
│  │  └──────────────┘  └──────────────┘                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      Next.js API层                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              API Routes + Server Actions                  │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │  │
│  │  │ /api/crawl   │  │ /api/news    │  │ /api/notify  │ │  │
│  │  │ - 触发爬取    │  │ - 查询新闻   │  │ - 发送通知   │ │  │
│  │  │ - 爬取状态    │  │ - 筛选排序   │  │ - 推送记录   │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘ │  │
│  │  ┌──────────────┐  ┌──────────────┐                    │  │
│  │  │ /api/config  │  │ /api/analytics│                    │  │
│  │  │ - 配置管理    │  │ - 数据分析   │                    │  │
│  │  │ - 关键词管理  │  │ - 统计查询   │                    │  │
│  │  └──────────────┘  └──────────────┘                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼────────┐  ┌──────────▼──────────┐  ┌─────────▼────────┐
│  业务服务层     │  │   数据处理层         │  │   通知推送层     │
│                │  │                     │  │                  │
│ CrawlerService │  │ MatcherService      │  │ NotifierService  │
│ - HTTP请求     │  │ - 关键词匹配         │  │ - 飞书推送        │
│ - 错误重试     │  │ - 权重计算           │  │ - 钉钉推送        │
│ - 代理支持     │  │ - 增量检测           │  │ - 企业微信推送    │
│                │  │ - 时间追踪           │  │ - Telegram推送   │
│                │  │ - 排名统计           │  │ - 邮件推送        │
│                │  │                     │  │ - ntfy推送       │
└────────────────┘  └─────────────────────┘  └──────────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        数据访问层                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Prisma ORM                             │  │
│  │  - 类型安全的数据库访问                                    │  │
│  │  - 查询构建器                                             │  │
│  │  - 关系处理                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        数据存储层                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Neon PostgreSQL (Serverless)                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │  │
│  │  │ 新闻表        │  │ 平台表       │  │ 配置表       │ │  │
│  │  │ - 标题        │  │ - 平台信息   │  │ - 关键词配置 │ │  │
│  │  │ - 链接        │  │ - 平台状态   │  │ - 通知配置   │ │  │
│  │  │ - 排名        │  │              │  │ - 系统配置   │ │  │
│  │  │ - 时间        │  │              │  │              │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘ │  │
│  │  ┌──────────────┐  ┌──────────────┐                    │  │
│  │  │ 匹配记录表    │  │ 推送记录表   │                    │  │
│  │  │ - 匹配关系    │  │ - 推送历史   │                    │  │
│  │  │ - 权重分数    │  │ - 推送状态   │                    │  │
│  │  └──────────────┘  └──────────────┘                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Vercel KV / Redis (缓存)                    │  │
│  │  - 热点数据缓存                                           │  │
│  │  - 查询结果缓存                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Vercel Blob / S3 (文件存储)                  │  │
│  │  - HTML报告存储                                           │  │
│  │  - 附件存储                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    定时任务层 (Vercel Cron)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 定时爬取任务  │  │ 数据清理任务  │  │ 报告生成任务  │         │
│  │ - 每小时执行  │  │ - 每日执行    │  │ - 按需执行    │         │
│  │ - 爬取所有平台│  │ - 清理旧数据  │  │ - 生成报告    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    MCP AI分析层 (可选)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 数据查询工具  │  │ 分析工具     │  │ 搜索工具     │         │
│  │ - 最新新闻    │  │ - 趋势分析   │  │ - 关键词搜索  │         │
│  │ - 按日期查询  │  │ - 数据洞察   │  │ - 历史检索   │         │
│  │ - 热点话题    │  │ - 情感分析   │  │              │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐                            │
│  │ 配置管理工具  │  │ 系统管理工具  │                            │
│  │ - 配置查询    │  │ - 系统状态   │                            │
│  │              │  │ - 触发爬取   │                            │
│  └──────────────┘  └──────────────┘                            │
│                                                                 │
│  通过MCP协议与AI客户端（如Claude Desktop）交互                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术架构分层

#### 1.2.1 表现层 (Presentation Layer)

**职责**: 用户界面展示和交互

**技术栈**:
- Next.js App Router
- React Server Components
- Tailwind CSS + shadcn/ui
- React Query (服务端状态管理)

**特点**:
- 服务端渲染，首屏加载快
- 客户端交互，响应迅速
- 响应式设计，支持移动端
- 实时数据更新

#### 1.2.2 API层 (API Layer)

**职责**: 提供RESTful API接口

**技术栈**:
- Next.js API Routes
- Next.js Server Actions
- Zod (数据验证)

**特点**:
- 类型安全的API
- 自动请求验证
- 统一的错误处理
- 支持流式响应

#### 1.2.3 业务逻辑层 (Business Logic Layer)

**职责**: 核心业务逻辑处理

**组件**:
- `CrawlerService` - 数据爬取服务
- `MatcherService` - 关键词匹配服务
- `CalculatorService` - 权重计算服务
- `ReportService` - 报告生成服务
- `NotifierService` - 通知推送服务

**特点**:
- 单一职责原则
- 可测试性强
- 易于扩展

#### 1.2.4 数据访问层 (Data Access Layer)

**职责**: 数据库访问和ORM映射

**技术栈**:
- Prisma ORM
- Neon PostgreSQL

**特点**:
- 类型安全的数据库访问
- 自动生成TypeScript类型
- 版本化数据库迁移
- 查询优化

#### 1.2.5 数据存储层 (Data Storage Layer)

**职责**: 数据持久化存储

**组件**:
- Neon PostgreSQL - 主数据库
- Vercel KV / Redis - 缓存
- Vercel Blob / S3 - 文件存储

**特点**:
- Serverless，自动扩缩容
- 高可用性
- 数据备份和恢复

---

## 2. 模块划分

### 2.1 目录结构

```
newsFocus-hf/
├── app/                          # Next.js App Router
│   ├── (dashboard)/             # 仪表板路由组
│   │   ├── layout.tsx          # 仪表板布局
│   │   ├── page.tsx            # 首页（数据概览）
│   │   ├── news/               # 新闻相关页面
│   │   │   ├── page.tsx        # 新闻列表页
│   │   │   └── [id]/page.tsx   # 新闻详情页
│   │   ├── analytics/          # 数据分析页面
│   │   │   ├── page.tsx        # 数据分析首页
│   │   │   └── trends/page.tsx # 趋势分析页
│   │   ├── history/            # 历史查询页面
│   │   │   └── page.tsx        # 历史查询页
│   │   └── settings/           # 设置页面
│   │       ├── page.tsx        # 设置首页
│   │       ├── keywords/page.tsx # 关键词配置
│   │       └── notifications/page.tsx # 通知配置
│   ├── api/                    # API Routes
│   │   ├── crawl/              # 爬取相关API
│   │   │   ├── route.ts        # POST /api/crawl - 触发爬取
│   │   │   └── status/route.ts # GET /api/crawl/status - 爬取状态
│   │   ├── news/               # 新闻相关API
│   │   │   ├── route.ts        # GET /api/news - 查询新闻
│   │   │   └── [id]/route.ts   # GET /api/news/[id] - 新闻详情
│   │   ├── notify/             # 通知相关API
│   │   │   ├── route.ts        # POST /api/notify - 发送通知
│   │   │   └── history/route.ts # GET /api/notify/history - 推送历史
│   │   ├── config/             # 配置相关API
│   │   │   ├── route.ts        # GET/PUT /api/config - 配置管理
│   │   │   ├── keywords/route.ts # GET/POST/DELETE /api/config/keywords
│   │   │   └── platforms/route.ts # GET/PUT /api/config/platforms
│   │   └── analytics/          # 数据分析API
│   │       ├── route.ts        # GET /api/analytics - 统计数据
│   │       └── trends/route.ts # GET /api/analytics/trends - 趋势数据
│   ├── layout.tsx              # 根布局
│   └── globals.css             # 全局样式
├── components/                  # React组件
│   ├── ui/                     # shadcn/ui基础组件
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── table.tsx
│   │   └── ...
│   ├── news/                   # 新闻相关组件
│   │   ├── NewsList.tsx        # 新闻列表组件
│   │   ├── NewsCard.tsx        # 新闻卡片组件
│   │   ├── NewsFilter.tsx      # 新闻筛选组件
│   │   └── NewsDetail.tsx      # 新闻详情组件
│   ├── charts/                 # 图表组件
│   │   ├── TrendChart.tsx      # 趋势图表
│   │   ├── PlatformChart.tsx   # 平台分布图表
│   │   └── KeywordChart.tsx    # 关键词统计图表
│   ├── forms/                  # 表单组件
│   │   ├── KeywordForm.tsx     # 关键词配置表单
│   │   ├── NotificationForm.tsx # 通知配置表单
│   │   └── PlatformForm.tsx    # 平台配置表单
│   └── layout/                 # 布局组件
│       ├── Header.tsx          # 头部组件
│       ├── Sidebar.tsx         # 侧边栏组件
│       └── Footer.tsx          # 页脚组件
├── lib/                        # 工具库
│   ├── db/                     # 数据库相关
│   │   ├── prisma.ts           # Prisma客户端单例
│   │   └── seed.ts             # 数据库种子数据
│   ├── services/               # 业务服务
│   │   ├── crawler.ts          # 爬虫服务
│   │   ├── matcher.ts          # 关键词匹配服务
│   │   ├── calculator.ts       # 权重计算服务
│   │   ├── report.ts           # 报告生成服务
│   │   └── notifier.ts         # 通知推送服务
│   ├── utils/                  # 工具函数
│   │   ├── date.ts             # 日期处理
│   │   ├── format.ts           # 格式化工具
│   │   └── validation.ts       # 验证工具
│   └── constants/              # 常量定义
│       ├── platforms.ts        # 平台常量
│       └── config.ts           # 配置常量
├── prisma/                     # Prisma配置
│   ├── schema.prisma           # 数据库模型定义
│   └── migrations/             # 数据库迁移文件
├── types/                      # TypeScript类型定义
│   ├── news.ts                 # 新闻相关类型
│   ├── config.ts               # 配置相关类型
│   └── api.ts                  # API相关类型
├── public/                     # 静态资源
│   ├── images/                 # 图片资源
│   └── icons/                  # 图标资源
├── config/                     # 配置文件（可选，用于迁移）
│   ├── config.yaml
│   └── frequency_words.txt
├── mcp_server/                 # MCP服务器（可选）
│   ├── server.ts               # MCP服务器入口
│   ├── tools/                  # MCP工具
│   └── services/               # MCP服务
├── scripts/                    # 脚本文件
│   ├── crawl.ts                # 爬取脚本
│   └── migrate.ts              # 数据迁移脚本
├── .env.example                 # 环境变量示例
├── .env.local                   # 本地环境变量（不提交）
├── next.config.js               # Next.js配置
├── tailwind.config.js           # Tailwind配置
├── tsconfig.json                # TypeScript配置
├── package.json                 # 项目依赖
└── README.md                    # 项目说明
```

### 2.2 核心模块说明

#### 2.2.1 前端模块 (app/)

**仪表板模块** (`app/(dashboard)/`):
- 数据概览页面
- 新闻列表和详情
- 数据分析和可视化
- 历史查询
- 配置管理

**API模块** (`app/api/`):
- RESTful API接口
- 统一的错误处理
- 请求验证

#### 2.2.2 组件模块 (components/)

**UI组件** (`components/ui/`):
- 基于shadcn/ui的基础组件
- 可复用的UI元素

**业务组件** (`components/news/`, `components/charts/`):
- 新闻展示组件
- 数据可视化组件
- 表单组件

#### 2.2.3 服务模块 (lib/services/)

**CrawlerService** (`lib/services/crawler.ts`):
- 数据爬取逻辑
- 错误处理和重试
- 代理支持

**MatcherService** (`lib/services/matcher.ts`):
- 关键词匹配算法
- 词组处理
- 过滤逻辑

**CalculatorService** (`lib/services/calculator.ts`):
- 权重计算
- 排序算法
- 统计计算

**ReportService** (`lib/services/report.ts`):
- HTML报告生成
- 消息格式化
- 模板渲染

**NotifierService** (`lib/services/notifier.ts`):
- 多渠道推送
- 分批处理
- 推送记录

#### 2.2.4 数据模块 (prisma/)

**数据库模型** (`prisma/schema.prisma`):
- 表结构定义
- 关系定义
- 索引定义

**迁移文件** (`prisma/migrations/`):
- 版本化数据库变更
- 自动生成迁移脚本

---

## 3. 数据流设计

### 3.1 爬取数据流

```
定时任务触发
    ↓
调用 /api/crawl
    ↓
CrawlerService.fetchData()
    ↓
HTTP请求外部API
    ↓
解析响应数据
    ↓
Prisma写入数据库
    ↓
触发关键词匹配
    ↓
更新匹配记录
    ↓
计算权重
    ↓
生成报告（可选）
    ↓
发送通知（可选）
```

### 3.2 查询数据流

```
用户请求页面
    ↓
Next.js Server Component
    ↓
调用 Prisma 查询
    ↓
从 Neon 数据库读取
    ↓
（可选）缓存到 Vercel KV
    ↓
返回数据到组件
    ↓
渲染HTML
    ↓
发送到客户端
```

### 3.3 通知推送流

```
定时任务或手动触发
    ↓
检查推送条件
    ↓
查询匹配的新闻
    ↓
生成消息内容
    ↓
分批处理（如需要）
    ↓
调用 NotifierService
    ↓
发送到各渠道
    ↓
记录推送状态
    ↓
保存到数据库
```

---

## 4. 部署架构

### 4.1 Vercel部署架构

```
┌─────────────────────────────────────────┐
│         Vercel Edge Network            │
│  (全球CDN，自动路由到最近节点)           │
└───────────────┬─────────────────────────┘
                │
┌───────────────▼─────────────────────────┐
│      Vercel Serverless Functions        │
│  ┌───────────────────────────────────┐ │
│  │  Next.js API Routes               │ │
│  │  - 自动扩缩容                      │ │
│  │  - 按需执行                        │ │
│  │  - 冷启动优化                      │ │
│  └───────────────────────────────────┘ │
└───────────────┬─────────────────────────┘
                │
        ┌───────┼───────┐
        │       │       │
┌───────▼──┐ ┌──▼───┐ ┌─▼────────┐
│   Neon   │ │ Vercel│ │ Vercel  │
│PostgreSQL│ │  KV   │ │  Blob   │
│          │ │       │ │         │
│Serverless│ │Redis  │ │  S3     │
└──────────┘ └───────┘ └─────────┘
```

### 4.2 定时任务架构

```
Vercel Cron Jobs
    ↓
定时触发 (每小时)
    ↓
调用 /api/crawl
    ↓
执行爬取任务
    ↓
更新数据库
    ↓
（可选）发送通知
```

---

## 5. 安全架构

### 5.1 安全层

1. **API安全**: 
   - 请求验证（Zod）
   - 速率限制（Vercel Edge Config）
   - CORS配置

2. **数据安全**:
   - 环境变量加密
   - 数据库连接加密（SSL）
   - 敏感信息不记录日志

3. **部署安全**:
   - Vercel自动HTTPS
   - 环境变量隔离
   - 访问控制

---

## 6. 性能优化架构

### 6.1 缓存策略

```
用户请求
    ↓
检查 Vercel KV 缓存
    ↓
缓存命中？
    ├─ 是 → 返回缓存数据
    └─ 否 → 查询数据库 → 写入缓存 → 返回数据
```

### 6.2 数据库优化

- 索引优化
- 查询优化
- 连接池管理
- 读写分离（Neon支持）

### 6.3 前端优化

- Server Components减少客户端JS
- 图片优化（Next.js Image）
- 代码分割
- 预加载关键资源

---

## 7. 扩展性设计

### 7.1 水平扩展

- **Serverless架构**: 自动扩缩容
- **数据库**: Neon自动扩展
- **缓存**: Vercel KV自动扩展

### 7.2 功能扩展

- **插件化服务**: 易于添加新的通知渠道
- **模块化组件**: 易于添加新的功能模块
- **API扩展**: 易于添加新的API端点

---

## 8. 监控和日志

### 8.1 监控

- **Vercel Analytics**: 性能监控
- **Vercel Speed Insights**: 速度监控
- **自定义监控**: 关键指标监控

### 8.2 日志

- **Vercel Logs**: 应用日志
- **数据库日志**: Neon日志
- **错误追踪**: Sentry集成（可选）

---

## 相关文档

- [01-系统概述.md](./01-系统概述.md) - 系统概述
- [03-核心模块设计.md](./03-核心模块设计.md) - 核心模块详细设计
- [04-数据模型设计.md](./04-数据模型设计.md) - 数据库模型设计

