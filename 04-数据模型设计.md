# 新闻热点聚合系统 - 数据模型设计

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. 数据库设计概述

### 1.1 数据库选型

- **数据库**: Neon PostgreSQL (Serverless PostgreSQL)
- **ORM**: Prisma
- **迁移工具**: Prisma Migrate
- **特点**: 
  - Serverless，自动扩缩容
  - 标准PostgreSQL，功能完整
  - 支持分支，方便开发测试
  - 与Vercel完美集成

### 1.2 数据库设计原则

1. **规范化设计**: 遵循数据库范式，减少数据冗余
2. **索引优化**: 为常用查询字段添加索引
3. **关系设计**: 合理使用外键和关系
4. **扩展性**: 预留扩展字段，便于后续功能扩展
5. **性能优化**: 考虑查询性能，合理设计表结构

---

## 2. 数据模型设计

### 2.1 Prisma Schema定义

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 平台表
model Platform {
  id          String   @id @default(cuid())
  platformId  String   @unique // 平台ID，如 "zhihu", "weibo"
  name        String   // 平台名称，如 "知乎", "微博"
  enabled     Boolean  @default(true) // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  newsItems   NewsItem[]

  @@index([platformId])
  @@index([enabled])
}

// 新闻项表
model NewsItem {
  id          String   @id @default(cuid())
  platformId  String   // 平台ID
  title       String   // 新闻标题
  url         String?  // PC链接
  mobileUrl   String?  // 移动端链接
  rank        Int      // 排名（1-10）
  crawledAt   DateTime @default(now()) // 爬取时间
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  platform    Platform @relation(fields: [platformId], references: [platformId])
  matches      NewsMatch[]
  appearances  NewsAppearance[]

  @@index([platformId, crawledAt])
  @@index([title])
  @@index([crawledAt])
  @@unique([platformId, title, crawledAt]) // 防止重复
}

// 关键词组表
model KeywordGroup {
  id            String   @id @default(cuid())
  name          String?  // 词组名称（可选）
  words         String[] // 普通词列表
  requiredWords String[] // 必须词列表（带+前缀）
  excludedWords String[] // 过滤词列表（带!前缀）
  priority      Int      @default(0) // 优先级（数字越小优先级越高）
  enabled       Boolean  @default(true) // 是否启用
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  matches       NewsMatch[]

  @@index([priority])
  @@index([enabled])
}

// 新闻匹配记录表
model NewsMatch {
  id            String   @id @default(cuid())
  newsItemId    String   // 新闻项ID
  keywordGroupId String  // 关键词组ID
  weight        Float    // 权重分数
  matchCount    Int      @default(1) // 匹配次数（同一新闻在不同时间出现）
  firstMatchedAt DateTime @default(now()) // 首次匹配时间
  lastMatchedAt  DateTime @default(now()) // 最后匹配时间
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  newsItem      NewsItem @relation(fields: [newsItemId], references: [id], onDelete: Cascade)
  keywordGroup  KeywordGroup @relation(fields: [keywordGroupId], references: [id], onDelete: Cascade)
  appearances   NewsAppearance[]

  @@unique([newsItemId, keywordGroupId])
  @@index([weight])
  @@index([keywordGroupId, weight])
  @@index([lastMatchedAt])
}

// 新闻出现记录表（记录新闻在不同时间的排名）
model NewsAppearance {
  id          String   @id @default(cuid())
  newsItemId  String   // 新闻项ID
  matchId     String?  // 匹配记录ID（可选）
  rank        Int      // 排名
  appearedAt  DateTime @default(now()) // 出现时间
  createdAt   DateTime @default(now())

  // 关系
  newsItem    NewsItem @relation(fields: [newsItemId], references: [id], onDelete: Cascade)
  match       NewsMatch? @relation(fields: [matchId], references: [id], onDelete: SetNull)

  @@index([newsItemId, appearedAt])
  @@index([matchId])
  @@index([appearedAt])
}

// 推送记录表
model PushRecord {
  id          String   @id @default(cuid())
  channel     String   // 推送渠道：feishu, dingtalk, wework, telegram, email, ntfy
  reportType  String   // 报告类型：daily, current, incremental
  reportDate  DateTime // 报告日期
  pushedAt    DateTime @default(now()) // 推送时间
  success     Boolean  @default(true) // 是否成功
  errorMessage String? // 错误信息（如果失败）
  createdAt   DateTime @default(now())

  @@unique([channel, reportDate, reportType])
  @@index([reportDate])
  @@index([channel, reportDate])
  @@index([pushedAt])
}

// 系统配置表
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique // 配置键
  value       Json     // 配置值（JSON格式）
  description String?  // 配置说明
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([key])
}

// 爬取任务记录表
model CrawlTask {
  id          String   @id @default(cuid())
  status      String   @default("pending") // pending, running, completed, failed
  startedAt   DateTime? // 开始时间
  completedAt DateTime? // 完成时间
  successCount Int      @default(0) // 成功爬取的平台数
  failedCount  Int      @default(0) // 失败的平台数
  errorMessage String?  // 错误信息
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}
```

### 2.2 数据模型说明

#### 2.2.1 Platform（平台表）

**用途**: 存储平台信息

**字段说明**:
- `platformId`: 平台唯一标识（如 "zhihu", "weibo"）
- `name`: 平台显示名称（如 "知乎", "微博"）
- `enabled`: 是否启用该平台

**关系**:
- 一对多：一个平台有多条新闻项

#### 2.2.2 NewsItem（新闻项表）

**用途**: 存储爬取的新闻数据

**字段说明**:
- `title`: 新闻标题
- `url`: PC端链接
- `mobileUrl`: 移动端链接
- `rank`: 排名（1-10）
- `crawledAt`: 爬取时间

**关系**:
- 多对一：多条新闻属于一个平台
- 一对多：一条新闻可以有多个匹配记录
- 一对多：一条新闻可以有多个出现记录

**唯一约束**: `platformId + title + crawledAt` 防止重复数据

#### 2.2.3 KeywordGroup（关键词组表）

**用途**: 存储关键词配置

**字段说明**:
- `name`: 词组名称（可选，用于显示）
- `words`: 普通词列表（数组）
- `requiredWords`: 必须词列表（带+前缀）
- `excludedWords`: 过滤词列表（带!前缀）
- `priority`: 优先级（数字越小优先级越高）
- `enabled`: 是否启用

**关系**:
- 一对多：一个词组可以匹配多条新闻

#### 2.2.4 NewsMatch（新闻匹配记录表）

**用途**: 记录新闻与关键词组的匹配关系

**字段说明**:
- `weight`: 权重分数（计算得出）
- `matchCount`: 匹配次数（同一新闻在不同时间出现）
- `firstMatchedAt`: 首次匹配时间
- `lastMatchedAt`: 最后匹配时间

**关系**:
- 多对一：一个匹配记录属于一条新闻
- 多对一：一个匹配记录属于一个关键词组
- 一对多：一个匹配记录可以有多个出现记录

**唯一约束**: `newsItemId + keywordGroupId` 确保一条新闻对一个词组只有一个匹配记录

#### 2.2.5 NewsAppearance（新闻出现记录表）

**用途**: 记录新闻在不同时间的排名情况

**字段说明**:
- `rank`: 排名
- `appearedAt`: 出现时间

**关系**:
- 多对一：一个出现记录属于一条新闻
- 多对一：一个出现记录可以属于一个匹配记录（可选）

**用途**: 用于计算权重和追踪新闻排名变化

#### 2.2.6 PushRecord（推送记录表）

**用途**: 记录推送历史

**字段说明**:
- `channel`: 推送渠道
- `reportType`: 报告类型
- `reportDate`: 报告日期
- `pushedAt`: 推送时间
- `success`: 是否成功
- `errorMessage`: 错误信息

**唯一约束**: `channel + reportDate + reportType` 防止重复推送

#### 2.2.7 SystemConfig（系统配置表）

**用途**: 存储系统配置（替代config.yaml）

**字段说明**:
- `key`: 配置键
- `value`: 配置值（JSON格式）
- `description`: 配置说明

**示例数据**:
```json
{
  "key": "crawler.request_interval",
  "value": 1000,
  "description": "请求间隔（毫秒）"
}
```

#### 2.2.8 CrawlTask（爬取任务记录表）

**用途**: 记录爬取任务执行情况

**字段说明**:
- `status`: 任务状态
- `startedAt`: 开始时间
- `completedAt`: 完成时间
- `successCount`: 成功数量
- `failedCount`: 失败数量
- `errorMessage`: 错误信息

---

## 3. 数据关系图

```
Platform (平台)
    │
    │ 1:N
    │
    ▼
NewsItem (新闻项)
    │
    │ 1:N                   1:N
    │                        │
    ▼                        ▼
NewsMatch (匹配记录)    NewsAppearance (出现记录)
    │                        │
    │ N:1                    │ N:1
    │                        │
    ▼                        ▼
KeywordGroup (关键词组)  NewsItem (新闻项)
```

---

## 4. 索引设计

### 4.1 主要索引

#### Platform表
- `platformId` (唯一索引)
- `enabled` (普通索引)

#### NewsItem表
- `platformId + crawledAt` (复合索引，用于按平台和时间查询)
- `title` (普通索引，用于搜索)
- `crawledAt` (普通索引，用于时间范围查询)
- `platformId + title + crawledAt` (唯一索引)

#### KeywordGroup表
- `priority` (普通索引，用于排序)
- `enabled` (普通索引，用于筛选)

#### NewsMatch表
- `weight` (普通索引，用于排序)
- `keywordGroupId + weight` (复合索引，用于按词组和权重查询)
- `lastMatchedAt` (普通索引，用于时间查询)
- `newsItemId + keywordGroupId` (唯一索引)

#### NewsAppearance表
- `newsItemId + appearedAt` (复合索引，用于按新闻和时间查询)
- `matchId` (普通索引，用于关联查询)
- `appearedAt` (普通索引，用于时间范围查询)

#### PushRecord表
- `reportDate` (普通索引，用于日期查询)
- `channel + reportDate` (复合索引，用于按渠道和日期查询)
- `pushedAt` (普通索引，用于时间查询)

#### CrawlTask表
- `status` (普通索引，用于状态查询)
- `createdAt` (普通索引，用于时间排序)

---

## 5. 数据迁移策略

### 5.1 从文件系统迁移到数据库

如果已有文件系统数据，需要迁移到数据库：

1. **读取历史文件**: 解析 `output/YYYY年MM月DD日/txt/` 目录下的文件
2. **数据转换**: 将文件数据转换为数据库记录
3. **批量插入**: 使用Prisma批量插入数据
4. **数据验证**: 验证迁移数据的完整性

### 5.2 迁移脚本示例

```typescript
// scripts/migrate.ts
import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';

const prisma = new PrismaClient();

async function migrateFromFiles() {
  // 1. 读取所有历史文件
  // 2. 解析文件内容
  // 3. 转换为数据库记录
  // 4. 批量插入
}
```

---

## 6. 数据查询示例

### 6.1 查询最新新闻

```typescript
// 查询最新的50条新闻
const latestNews = await prisma.newsItem.findMany({
  take: 50,
  orderBy: { crawledAt: 'desc' },
  include: {
    platform: true,
    matches: {
      include: {
        keywordGroup: true
      }
    }
  }
});
```

### 6.2 查询匹配的新闻

```typescript
// 查询匹配特定关键词组的新闻
const matchedNews = await prisma.newsMatch.findMany({
  where: {
    keywordGroupId: 'xxx',
    weight: { gte: 50 } // 权重大于50
  },
  include: {
    newsItem: {
      include: {
        platform: true
      }
    },
    keywordGroup: true
  },
  orderBy: { weight: 'desc' }
});
```

### 6.3 查询统计数据

```typescript
// 查询今日统计数据
const today = new Date();
today.setHours(0, 0, 0, 0);

const stats = await prisma.newsMatch.groupBy({
  by: ['keywordGroupId'],
  where: {
    createdAt: { gte: today }
  },
  _count: true,
  _avg: {
    weight: true
  }
});
```

---

## 7. 数据备份和恢复

### 7.1 Neon数据库备份

Neon提供自动备份功能：
- **时间点恢复**: 支持恢复到任意时间点
- **自动备份**: 每天自动备份
- **手动备份**: 可通过Neon控制台手动备份

### 7.2 数据导出

```typescript
// 导出数据脚本
async function exportData() {
  const platforms = await prisma.platform.findMany();
  const newsItems = await prisma.newsItem.findMany();
  const keywordGroups = await prisma.keywordGroup.findMany();
  
  // 导出为JSON或CSV
}
```

---

## 8. 性能优化建议

### 8.1 查询优化

1. **使用索引**: 确保常用查询字段有索引
2. **限制结果**: 使用 `take` 和 `skip` 分页
3. **选择字段**: 使用 `select` 只查询需要的字段
4. **批量查询**: 使用 `findMany` 而不是循环 `findUnique`

### 8.2 写入优化

1. **批量插入**: 使用 `createMany` 批量插入
2. **事务处理**: 使用事务确保数据一致性
3. **异步处理**: 非关键操作异步处理

### 8.3 连接池优化

Prisma自动管理连接池，但可以通过环境变量配置：

```env
DATABASE_URL="postgresql://user:password@host:5432/dbname?connection_limit=10&pool_timeout=20"
```

---

## 相关文档

- [02-架构设计.md](./02-架构设计.md) - 架构设计
- [03-核心模块设计.md](./03-核心模块设计.md) - 核心模块设计
- [05-接口设计.md](./05-接口设计.md) - API接口设计

