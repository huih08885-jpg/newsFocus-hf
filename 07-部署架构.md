# 新闻热点聚合系统 - 部署架构

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. 部署概述

### 1.1 部署方式

系统支持多种部署方式：

1. **Vercel部署**（推荐）- Serverless，自动扩缩容
2. **Docker部署** - 容器化部署，适合自托管
3. **传统服务器部署** - 标准Node.js部署

### 1.2 部署架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Vercel部署（推荐）                     │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Vercel Edge Network (CDN)                │   │
│  │  - 全球CDN节点                                    │   │
│  │  - 自动路由到最近节点                              │   │
│  │  - DDoS防护                                       │   │
│  └──────────────────┬───────────────────────────────┘   │
│                     │                                    │
│  ┌──────────────────▼───────────────────────────────┐   │
│  │      Vercel Serverless Functions                 │   │
│  │  - Next.js API Routes                            │   │
│  │  - Server Components                             │   │
│  │  - 自动扩缩容                                     │   │
│  │  - 按需执行                                       │   │
│  └──────────────────┬───────────────────────────────┘   │
│                     │                                    │
│         ┌───────────┼───────────┐                       │
│         │           │           │                       │
│  ┌──────▼───┐ ┌─────▼────┐ ┌───▼────────┐             │
│  │   Neon   │ │  Vercel  │ │  Vercel    │             │
│  │PostgreSQL│ │    KV    │ │   Blob     │             │
│  │          │ │          │ │            │             │
│  │Serverless│ │  Redis   │ │    S3      │             │
│  └──────────┘ └──────────┘ └────────────┘             │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Vercel Cron Jobs                         │   │
│  │  - 定时爬取任务                                   │   │
│  │  - 数据清理任务                                   │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
```

---

## 2. Vercel部署（推荐）

### 2.1 前置要求

- GitHub/GitLab/Bitbucket账号
- Vercel账号（免费）
- Neon数据库账号（免费）

### 2.2 部署步骤

#### 步骤1: 准备代码仓库

```bash
# 初始化Git仓库
git init
git add .
git commit -m "Initial commit"

# 推送到GitHub
git remote add origin https://github.com/yourusername/newsFocus-hf.git
git push -u origin main
```

#### 步骤2: 创建Neon数据库

1. 访问 [Neon Console](https://console.neon.tech/)
2. 创建新项目
3. 记录数据库连接字符串

#### 步骤3: 配置Vercel项目

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 点击 "New Project"
3. 导入GitHub仓库
4. 配置项目设置：
   - **Framework Preset**: Next.js
   - **Root Directory**: ./
   - **Build Command**: `pnpm build`
   - **Output Directory**: .next

#### 步骤4: 配置环境变量

在Vercel项目设置中添加环境变量：

```env
# 数据库
DATABASE_URL="postgresql://user:password@host.neon.tech/dbname?sslmode=require"

# Next.js
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"

# Cron Secret（用于验证定时任务）
CRON_SECRET="your-random-secret-key"

# 通知配置（可选）
FEISHU_WEBHOOK_URL=""
DINGTALK_WEBHOOK_URL=""
TELEGRAM_BOT_TOKEN=""
TELEGRAM_CHAT_ID=""
EMAIL_FROM=""
EMAIL_PASSWORD=""
EMAIL_SMTP_SERVER=""
EMAIL_SMTP_PORT=""
NTFY_SERVER_URL="https://ntfy.sh"
NTFY_TOPIC=""
NTFY_TOKEN=""
```

#### 步骤5: 配置Vercel Cron

创建 `vercel.json` 文件：

```json
{
  "crons": [
    {
      "path": "/api/cron/crawl",
      "schedule": "0 * * * *"
    },
    {
      "path": "/api/cron/cleanup",
      "schedule": "0 2 * * *"
    }
  ]
}
```

#### 步骤6: 部署

Vercel会自动检测到代码推送并触发部署：

```bash
git push origin main
```

### 2.3 数据库迁移

部署后，需要运行数据库迁移：

```bash
# 方式1: 通过Vercel CLI
vercel env pull .env.local
npx prisma migrate deploy

# 方式2: 在Vercel部署后通过API触发
# 或使用Vercel的Post-Deploy Hook
```

### 2.4 验证部署

1. 访问部署的URL
2. 检查数据库连接
3. 测试API接口
4. 验证定时任务

---

## 3. Docker部署

### 3.1 Dockerfile

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# 安装依赖
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json pnpm-lock.yaml* ./
RUN corepack enable pnpm && pnpm install --frozen-lockfile

# 构建应用
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN corepack enable pnpm && pnpm build

# 生产镜像
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

### 3.2 docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - NEXT_PUBLIC_APP_URL=http://localhost:3000
      - CRON_SECRET=${CRON_SECRET}
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-newsfocus}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  cron:
    build: .
    command: node scripts/cron.js
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - CRON_SECRET=${CRON_SECRET}
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      - app
      - postgres

volumes:
  postgres_data:
```

### 3.3 部署步骤

```bash
# 1. 构建镜像
docker-compose build

# 2. 启动服务
docker-compose up -d

# 3. 运行数据库迁移
docker-compose exec app npx prisma migrate deploy

# 4. 查看日志
docker-compose logs -f app
```

---

## 4. 传统服务器部署

### 4.1 服务器要求

- Node.js 18+
- PostgreSQL 14+（或使用Neon）
- PM2（进程管理）

### 4.2 部署步骤

```bash
# 1. 克隆代码
git clone https://github.com/yourusername/newsFocus-hf.git
cd newsFocus-hf

# 2. 安装依赖
pnpm install

# 3. 构建应用
pnpm build

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 5. 运行数据库迁移
npx prisma migrate deploy

# 6. 启动应用（使用PM2）
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 4.3 PM2配置

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'newsFocus',
      script: 'node_modules/next/dist/bin/next',
      args: 'start',
      instances: 1,
      exec_mode: 'fork',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    }
  ]
};
```

### 4.4 Nginx配置

```nginx
# /etc/nginx/sites-available/newsFocus
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 5. 环境变量配置

### 5.1 必需环境变量

```env
# 数据库连接（必需）
DATABASE_URL="postgresql://user:password@host:5432/dbname"

# Next.js公共URL（必需）
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

### 5.2 可选环境变量

```env
# Cron Secret（定时任务安全验证）
CRON_SECRET="your-random-secret-key"

# 通知配置
FEISHU_WEBHOOK_URL=""
DINGTALK_WEBHOOK_URL=""
WEWORK_WEBHOOK_URL=""
TELEGRAM_BOT_TOKEN=""
TELEGRAM_CHAT_ID=""
EMAIL_FROM=""
EMAIL_PASSWORD=""
EMAIL_SMTP_SERVER=""
EMAIL_SMTP_PORT=""
NTFY_SERVER_URL="https://ntfy.sh"
NTFY_TOPIC=""
NTFY_TOKEN=""

# 爬虫配置
PROXY_URL=""
REQUEST_INTERVAL="1000"

# MCP服务器（可选）
ENABLE_MCP_SERVER="false"
```

---

## 6. 数据库迁移

### 6.1 开发环境迁移

```bash
# 创建迁移
npx prisma migrate dev --name init

# 应用迁移
npx prisma migrate deploy
```

### 6.2 生产环境迁移

```bash
# 仅应用迁移（不创建新迁移）
npx prisma migrate deploy

# 生成Prisma客户端
npx prisma generate
```

### 6.3 迁移脚本

```typescript
// scripts/migrate.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // 运行迁移后的初始化逻辑
  // 例如：创建默认平台、配置等
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

---

## 7. 定时任务配置

### 7.1 Vercel Cron配置

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/crawl",
      "schedule": "0 * * * *"
    },
    {
      "path": "/api/cron/cleanup",
      "schedule": "0 2 * * *"
    }
  ]
}
```

### 7.2 Cron API实现

```typescript
// app/api/cron/crawl/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  // 验证Cron Secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 执行爬取任务
  // ...

  return NextResponse.json({ success: true });
}
```

### 7.3 Docker环境定时任务

使用 `node-cron` 或 `supercronic`：

```typescript
// scripts/cron.ts
import cron from 'node-cron';
import { crawlAllPlatforms } from '@/lib/services/crawler';

// 每小时执行
cron.schedule('0 * * * *', async () => {
  console.log('Running crawl task...');
  await crawlAllPlatforms();
});
```

---

## 8. 监控和日志

### 8.1 Vercel监控

- **Vercel Analytics**: 性能监控
- **Vercel Speed Insights**: 速度监控
- **Vercel Logs**: 应用日志

### 8.2 自定义监控

```typescript
// lib/monitoring.ts
export async function logError(error: Error, context?: any) {
  // 发送到监控服务（如Sentry）
  console.error('Error:', error, context);
}

export async function logMetric(name: string, value: number) {
  // 记录指标
  console.log(`Metric: ${name} = ${value}`);
}
```

### 8.3 健康检查

```typescript
// app/api/health/route.ts
import { NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function GET() {
  try {
    // 检查数据库连接
    await prisma.$queryRaw`SELECT 1`;
    
    return NextResponse.json({
      status: 'healthy',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    return NextResponse.json(
      {
        status: 'unhealthy',
        error: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
```

---

## 9. 备份和恢复

### 9.1 Neon自动备份

Neon提供自动备份功能：
- 时间点恢复（PITR）
- 自动每日备份
- 手动备份

### 9.2 数据导出脚本

```typescript
// scripts/backup.ts
import { PrismaClient } from '@prisma/client';
import fs from 'fs';

const prisma = new PrismaClient();

async function backup() {
  const data = {
    platforms: await prisma.platform.findMany(),
    keywordGroups: await prisma.keywordGroup.findMany(),
    // ... 其他数据
  };

  fs.writeFileSync(
    `backup-${Date.now()}.json`,
    JSON.stringify(data, null, 2)
  );
}

backup();
```

---

## 10. 故障排查

### 10.1 常见问题

1. **数据库连接失败**
   - 检查 `DATABASE_URL` 环境变量
   - 检查数据库是否可访问
   - 检查SSL配置

2. **定时任务不执行**
   - 检查Vercel Cron配置
   - 检查 `CRON_SECRET` 配置
   - 查看Vercel日志

3. **构建失败**
   - 检查Node.js版本
   - 检查依赖安装
   - 查看构建日志

### 10.2 调试技巧

```bash
# 查看Vercel日志
vercel logs

# 本地测试
vercel dev

# 检查环境变量
vercel env ls

# 数据库连接测试
npx prisma studio
```

---

## 相关文档

- [08-安全设计.md](./08-安全设计.md) - 安全设计
- [09-性能设计.md](./09-性能设计.md) - 性能优化

