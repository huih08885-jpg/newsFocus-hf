# 关键词匹配问题排查指南

## 🔍 问题：关键词设置好像没有用

如果你发现设置了关键词组，但没有看到匹配结果，请按照以下步骤排查：

## 📋 排查步骤

### 步骤 1: 检查关键词组配置

1. 访问 `/settings/keywords`
2. 确认：
   - ✅ 至少有一个关键词组
   - ✅ 关键词组已**启用**（显示"启用"标签）
   - ✅ 关键词拼写正确
   - ✅ 普通词、必须词、过滤词设置合理

### 步骤 2: 运行诊断工具

使用诊断脚本检查系统状态：

```bash
pnpm test:keyword
```

诊断工具会检查：
- 关键词组是否存在且启用
- 是否有新闻数据
- 是否有匹配记录
- 匹配功能是否正常

### 步骤 3: 检查新闻数据

关键词匹配需要先有新闻数据：

1. **运行爬取任务**
   - 访问首页或 `/platforms` 页面
   - 点击"立即爬取"按钮
   - 等待爬取完成

2. **确认有新闻数据**
   - 访问 `/news` 页面
   - 查看是否有新闻列表
   - 如果没有新闻，说明爬取失败

### 步骤 4: 手动触发匹配

**重要**：关键词匹配在以下情况会自动执行：
- ✅ 爬取任务成功完成后（只匹配最近1小时的新闻）

**如果爬取任务失败，或者想匹配所有历史新闻，需要手动触发：**

1. 访问 `/settings/keywords`
2. 点击 **"手动匹配所有新闻"** 按钮
3. 等待匹配完成
4. 查看匹配结果

### 步骤 5: 验证匹配结果

1. **查看新闻列表**
   - 访问 `/news` 页面
   - 匹配的新闻会显示：
     - 关键词组标签（如 "AI人工智能"）
     - 权重分数
     - 匹配次数

2. **按关键词组筛选**
   - 在筛选栏选择关键词组
   - 只显示匹配该词组的新闻

3. **使用测试功能**
   - 在关键词组列表中，点击"测试"按钮
   - 输入新闻标题测试匹配逻辑

## 🐛 常见问题

### Q1: 为什么设置了关键词组，但没有匹配到新闻？

**可能原因**：
1. ❌ 关键词组未启用
2. ❌ 没有运行爬取任务
3. ❌ 新闻标题不包含关键词
4. ❌ 必须词或过滤词设置太严格
5. ❌ 只匹配最近1小时的新闻，历史新闻未匹配

**解决方案**：
1. ✅ 确认关键词组已启用
2. ✅ 运行爬取任务获取最新新闻
3. ✅ 使用测试功能验证关键词组
4. ✅ 调整关键词设置
5. ✅ 点击"手动匹配所有新闻"匹配历史数据

### Q2: 爬取任务成功了，但没有匹配记录？

**可能原因**：
1. 匹配只针对最近1小时的新闻
2. 如果新闻是1小时前爬取的，就不会被匹配

**解决方案**：
- 点击"手动匹配所有新闻"按钮，匹配所有历史新闻

### Q3: 测试功能显示匹配成功，但新闻列表中没有标签？

**可能原因**：
1. 测试功能只是验证匹配逻辑，不会创建匹配记录
2. 需要运行爬取任务或手动匹配

**解决方案**：
- 运行爬取任务，或点击"手动匹配所有新闻"

### Q4: 如何匹配所有历史新闻？

**方法**：
1. 访问 `/settings/keywords`
2. 点击 **"手动匹配所有新闻"** 按钮
3. 系统会匹配数据库中所有新闻

### Q5: 匹配需要多长时间？

**时间**：
- 取决于新闻数量
- 通常每1000条新闻需要几秒钟
- 匹配过程是异步的，不会阻塞界面

## 🔧 手动匹配 API

如果需要通过 API 手动触发匹配：

```bash
# 匹配所有新闻
curl -X POST http://localhost:3000/api/news/match \
  -H "Content-Type: application/json" \
  -d '{"all": true}'

# 匹配最近1小时的新闻（默认）
curl -X POST http://localhost:3000/api/news/match \
  -H "Content-Type: application/json" \
  -d '{}'

# 匹配指定日期范围的新闻
curl -X POST http://localhost:3000/api/news/match \
  -H "Content-Type: application/json" \
  -d '{
    "dateFrom": "2025-01-15T00:00:00Z",
    "dateTo": "2025-01-16T23:59:59Z"
  }'
```

## 📊 检查匹配统计

访问 `/analytics` 页面，可以查看：
- 各关键词组的匹配数量
- 平均权重
- 匹配趋势

## ✅ 验证匹配是否正常工作

1. **创建测试关键词组**
   ```
   名称: 测试
   普通词: 测试
   优先级: 0
   状态: 启用
   ```

2. **运行爬取任务**

3. **手动匹配所有新闻**

4. **检查结果**
   - 访问 `/news` 页面
   - 查看是否有新闻显示"测试"标签
   - 如果有，说明匹配功能正常

## 🎯 最佳实践

1. **先测试，再使用**
   - 创建关键词组后，立即使用测试功能验证
   - 确保匹配逻辑正确

2. **定期运行匹配**
   - 每次爬取后，匹配会自动执行
   - 如果修改了关键词组，建议手动匹配一次

3. **检查匹配结果**
   - 定期查看新闻列表
   - 确认匹配结果符合预期
   - 根据实际情况调整关键词

4. **使用诊断工具**
   - 遇到问题时，运行 `pnpm test:keyword`
   - 查看详细的诊断信息

## 📚 相关文档

- `KEYWORD_GUIDE.md` - 关键词功能使用指南
- `CRAWLER_TROUBLESHOOTING.md` - 爬虫问题排查

