# 新闻热点聚合系统 - 安全设计

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. 安全概述

### 1.1 安全原则

1. **最小权限原则**: 只授予必要的权限
2. **纵深防御**: 多层安全防护
3. **数据加密**: 敏感数据加密存储和传输
4. **输入验证**: 所有输入都经过验证
5. **错误处理**: 不泄露敏感信息

### 1.2 威胁模型

- **数据泄露**: 数据库被攻击，敏感信息泄露
- **未授权访问**: API被恶意调用
- **注入攻击**: SQL注入、XSS攻击
- **DoS攻击**: 服务被拒绝服务攻击
- **配置错误**: 环境变量泄露

---

## 2. 认证和授权

### 2.1 单用户系统

当前系统为单用户系统，无需复杂的认证机制。但需要保护关键操作：

```typescript
// lib/auth.ts
export function verifyCronSecret(request: Request): boolean {
  const authHeader = request.headers.get('authorization');
  const expectedSecret = process.env.CRON_SECRET;
  
  if (!expectedSecret) {
    return false;
  }
  
  return authHeader === `Bearer ${expectedSecret}`;
}
```

### 2.2 API保护

```typescript
// app/api/crawl/route.ts
import { verifyCronSecret } from '@/lib/auth';

export async function POST(request: Request) {
  // 验证Cron Secret（仅定时任务调用）
  if (!verifyCronSecret(request)) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    );
  }
  
  // ... 执行操作
}
```

---

## 3. 数据安全

### 3.1 数据库安全

#### 3.1.1 连接加密

Neon数据库默认使用SSL连接：

```env
DATABASE_URL="postgresql://user:password@host/dbname?sslmode=require"
```

#### 3.1.2 SQL注入防护

使用Prisma ORM，自动防护SQL注入：

```typescript
// ✅ 安全：使用Prisma
const users = await prisma.user.findMany({
  where: { email: userInput }
});

// ❌ 不安全：直接拼接SQL
const query = `SELECT * FROM users WHERE email = '${userInput}'`;
```

#### 3.1.3 参数化查询

即使使用原始查询，也要使用参数化：

```typescript
// ✅ 安全：参数化查询
await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${userInput}
`;

// ❌ 不安全：字符串拼接
await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE email = '${userInput}'`
);
```

### 3.2 环境变量安全

#### 3.2.1 环境变量管理

- ✅ 使用 `.env.local` 存储敏感信息（不提交到Git）
- ✅ Vercel环境变量加密存储
- ✅ 不同环境使用不同的环境变量
- ❌ 不在代码中硬编码敏感信息

#### 3.2.2 环境变量验证

```typescript
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  NEXT_PUBLIC_APP_URL: z.string().url(),
  CRON_SECRET: z.string().min(32),
  // ... 其他环境变量
});

export const env = envSchema.parse(process.env);
```

### 3.3 敏感数据保护

#### 3.3.1 密码和Token

- ✅ 使用环境变量存储
- ✅ 不在日志中记录
- ✅ 不在错误消息中泄露

```typescript
// ✅ 安全：不记录敏感信息
console.log('Webhook URL configured'); // 不记录URL本身

// ❌ 不安全：记录敏感信息
console.log(`Webhook URL: ${process.env.FEISHU_WEBHOOK_URL}`);
```

#### 3.3.2 数据脱敏

```typescript
// lib/utils/mask.ts
export function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  const maskedLocal = local.slice(0, 2) + '***';
  return `${maskedLocal}@${domain}`;
}

export function maskUrl(url: string): string {
  try {
    const parsed = new URL(url);
    return `${parsed.protocol}//${parsed.hostname}/***`;
  } catch {
    return '***';
  }
}
```

---

## 4. 输入验证

### 4.1 API输入验证

使用Zod进行输入验证：

```typescript
// lib/validators/crawl.ts
import { z } from 'zod';

export const crawlRequestSchema = z.object({
  platforms: z.array(z.string()).optional(),
  force: z.boolean().optional().default(false)
});

export type CrawlRequest = z.infer<typeof crawlRequestSchema>;
```

```typescript
// app/api/crawl/route.ts
import { crawlRequestSchema } from '@/lib/validators/crawl';

export async function POST(request: Request) {
  const body = await request.json();
  
  // 验证输入
  const result = crawlRequestSchema.safeParse(body);
  if (!result.success) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: 'Invalid request data',
          details: result.error.errors
        }
      },
      { status: 400 }
    );
  }
  
  // 使用验证后的数据
  const { platforms, force } = result.data;
  // ...
}
```

### 4.2 SQL注入防护

Prisma自动防护，但要注意：

```typescript
// ✅ 安全：使用Prisma类型安全查询
const news = await prisma.newsItem.findMany({
  where: {
    title: { contains: userInput } // Prisma自动转义
  }
});

// ❌ 不安全：使用原始查询时未转义
await prisma.$queryRawUnsafe(
  `SELECT * FROM news WHERE title LIKE '%${userInput}%'`
);
```

### 4.3 XSS防护

Next.js自动转义，但要注意：

```typescript
// ✅ 安全：Next.js自动转义
<div>{userInput}</div>

// ❌ 不安全：使用dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userInput }} />

// ✅ 安全：如果需要HTML，先清理
import DOMPurify from 'isomorphic-dompurify';
<div dangerouslySetInnerHTML={{ 
  __html: DOMPurify.sanitize(userInput) 
}} />
```

---

## 5. 网络安全

### 5.1 HTTPS强制

Vercel自动提供HTTPS，确保：

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  // Vercel自动处理HTTPS重定向
  // 但可以添加额外的安全检查
  return NextResponse.next();
}
```

### 5.2 CORS配置

```typescript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.NEXT_PUBLIC_APP_URL || '*'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET, POST, PUT, DELETE, OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'Content-Type, Authorization'
          }
        ]
      }
    ];
  }
};
```

### 5.3 速率限制

```typescript
// lib/rate-limit.ts
import { LRUCache } from 'lru-cache';

const rateLimit = new LRUCache<string, number>({
  max: 500,
  ttl: 60000 // 1分钟
});

export function checkRateLimit(identifier: string, limit: number = 10): boolean {
  const count = rateLimit.get(identifier) || 0;
  
  if (count >= limit) {
    return false;
  }
  
  rateLimit.set(identifier, count + 1);
  return true;
}
```

```typescript
// app/api/news/route.ts
import { checkRateLimit } from '@/lib/rate-limit';

export async function GET(request: Request) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown';
  
  if (!checkRateLimit(ip, 100)) {
    return NextResponse.json(
      { error: 'Rate limit exceeded' },
      { status: 429 }
    );
  }
  
  // ... 处理请求
}
```

---

## 6. 错误处理

### 6.1 错误响应格式

不泄露敏感信息：

```typescript
// lib/errors.ts
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 500,
    public details?: any
  ) {
    super(message);
  }
}

export function handleError(error: unknown) {
  if (error instanceof AppError) {
    return {
      success: false,
      error: {
        code: error.code,
        message: error.message,
        ...(process.env.NODE_ENV === 'development' && {
          details: error.details
        })
      }
    };
  }
  
  // 生产环境不泄露内部错误
  return {
    success: false,
    error: {
      code: 'INTERNAL_ERROR',
      message: 'An internal error occurred'
    }
  };
}
```

### 6.2 日志记录

```typescript
// lib/logger.ts
export function logError(error: Error, context?: any) {
  // 记录错误，但不记录敏感信息
  console.error('Error:', {
    message: error.message,
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    context: sanitizeContext(context)
  });
  
  // 发送到监控服务（如Sentry）
  // Sentry.captureException(error, { extra: sanitizeContext(context) });
}

function sanitizeContext(context: any): any {
  if (!context) return context;
  
  const sanitized = { ...context };
  const sensitiveKeys = ['password', 'token', 'secret', 'key', 'url'];
  
  for (const key of sensitiveKeys) {
    if (key in sanitized) {
      sanitized[key] = '***';
    }
  }
  
  return sanitized;
}
```

---

## 7. 依赖安全

### 7.1 依赖检查

定期检查依赖漏洞：

```bash
# 使用npm audit
npm audit

# 使用pnpm audit
pnpm audit

# 自动修复
npm audit fix
```

### 7.2 依赖锁定

使用锁文件确保依赖版本一致：

```json
// package.json
{
  "packageManager": "pnpm@8.0.0"
}
```

### 7.3 依赖更新策略

- ✅ 定期更新依赖
- ✅ 测试更新后的依赖
- ✅ 使用Dependabot自动更新

---

## 8. 配置安全

### 8.1 配置文件安全

```typescript
// ✅ 安全：使用环境变量
const config = {
  databaseUrl: process.env.DATABASE_URL,
  apiKey: process.env.API_KEY
};

// ❌ 不安全：硬编码配置
const config = {
  databaseUrl: 'postgresql://user:password@host/db',
  apiKey: 'secret-key'
};
```

### 8.2 密钥轮换

定期轮换密钥和Token：

```typescript
// lib/key-rotation.ts
export async function rotateKeys() {
  // 1. 生成新密钥
  const newSecret = generateSecret();
  
  // 2. 更新环境变量（需要手动操作或通过API）
  // 3. 重启服务
  // 4. 删除旧密钥
}
```

---

## 9. 监控和告警

### 9.1 安全事件监控

```typescript
// lib/security-monitor.ts
export function logSecurityEvent(
  event: string,
  details: Record<string, any>
) {
  console.warn('Security Event:', {
    event,
    timestamp: new Date().toISOString(),
    details: sanitizeContext(details)
  });
  
  // 发送到安全监控服务
  // sendToSecurityService(event, details);
}

// 使用示例
logSecurityEvent('UNAUTHORIZED_ACCESS_ATTEMPT', {
  ip: request.headers.get('x-forwarded-for'),
  endpoint: request.url,
  method: request.method
});
```

### 9.2 异常检测

```typescript
// lib/anomaly-detection.ts
const requestCounts = new Map<string, number>();

export function detectAnomaly(identifier: string): boolean {
  const count = requestCounts.get(identifier) || 0;
  requestCounts.set(identifier, count + 1);
  
  // 检测异常：短时间内大量请求
  if (count > 1000) {
    logSecurityEvent('RATE_LIMIT_EXCEEDED', { identifier });
    return true;
  }
  
  return false;
}
```

---

## 10. 合规性

### 10.1 数据隐私

- ✅ 不收集用户个人信息
- ✅ 数据仅用于系统功能
- ✅ 提供数据删除功能

### 10.2 日志保留

```typescript
// lib/log-retention.ts
export async function cleanupOldLogs() {
  const retentionDays = 30;
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
  
  // 删除旧日志
  await prisma.log.deleteMany({
    where: {
      createdAt: { lt: cutoffDate }
    }
  });
}
```

---

## 11. 安全检查清单

### 11.1 部署前检查

- [ ] 所有环境变量已配置
- [ ] 数据库连接使用SSL
- [ ] 敏感信息不在代码中
- [ ] API有速率限制
- [ ] 错误处理不泄露敏感信息
- [ ] 依赖已更新且无漏洞
- [ ] HTTPS已启用
- [ ] 日志不包含敏感信息

### 11.2 定期检查

- [ ] 依赖安全扫描
- [ ] 密钥轮换
- [ ] 日志审查
- [ ] 访问日志审查
- [ ] 备份验证

---

## 相关文档

- [07-部署架构.md](./07-部署架构.md) - 部署架构
- [09-性能设计.md](./09-性能设计.md) - 性能优化

