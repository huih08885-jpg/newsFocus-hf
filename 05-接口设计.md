# 新闻热点聚合系统 - 接口设计

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. API设计概述

### 1.1 API架构

- **框架**: Next.js API Routes
- **格式**: RESTful API
- **数据格式**: JSON
- **认证**: 环境变量配置（单用户系统）
- **错误处理**: 统一错误响应格式

### 1.2 响应格式

#### 成功响应

```json
{
  "success": true,
  "data": { ... }
}
```

#### 错误响应

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": { ... }
  }
}
```

### 1.3 HTTP状态码

- `200` - 成功
- `400` - 请求参数错误
- `401` - 未授权
- `404` - 资源不存在
- `500` - 服务器内部错误

---

## 2. 爬取相关API

### 2.1 触发爬取

**接口**: `POST /api/crawl`

**功能**: 手动触发爬取任务

**请求体**:
```json
{
  "platforms": ["zhihu", "weibo"], // 可选，指定平台，不传则爬取所有启用平台
  "force": false // 可选，是否强制重新爬取
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "taskId": "clxxx...",
    "status": "running",
    "startedAt": "2025-01-15T10:00:00Z"
  }
}
```

**实现**:
```typescript
// app/api/crawl/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';
import { CrawlerService } from '@/lib/services/crawler';

export async function POST(request: NextRequest) {
  const body = await request.json();
  const { platforms, force } = body;

  const prisma = new PrismaClient();
  const crawler = new CrawlerService(prisma);

  try {
    // 创建爬取任务记录
    const task = await prisma.crawlTask.create({
      data: {
        status: 'running',
        startedAt: new Date()
      }
    });

    // 执行爬取
    const result = await crawler.crawlAllPlatforms(platforms);

    // 更新任务状态
    await prisma.crawlTask.update({
      where: { id: task.id },
      data: {
        status: 'completed',
        completedAt: new Date(),
        successCount: result.successCount,
        failedCount: result.failedCount
      }
    });

    return NextResponse.json({
      success: true,
      data: {
        taskId: task.id,
        ...result
      }
    });
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'CRAWL_ERROR',
          message: error instanceof Error ? error.message : 'Unknown error'
        }
      },
      { status: 500 }
    );
  }
}
```

### 2.2 查询爬取状态

**接口**: `GET /api/crawl/status`

**功能**: 查询最近的爬取任务状态

**查询参数**:
- `taskId` (可选): 任务ID，不传则返回最新任务

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "clxxx...",
    "status": "completed",
    "startedAt": "2025-01-15T10:00:00Z",
    "completedAt": "2025-01-15T10:05:00Z",
    "successCount": 10,
    "failedCount": 1,
    "errorMessage": null
  }
}
```

---

## 3. 新闻查询API

### 3.1 查询新闻列表

**接口**: `GET /api/news`

**功能**: 查询新闻列表，支持筛选和分页

**查询参数**:
- `platforms` (可选): 平台ID列表，逗号分隔，如 `zhihu,weibo`
- `keywordGroupId` (可选): 关键词组ID
- `minWeight` (可选): 最小权重，数字
- `dateFrom` (可选): 开始日期，ISO格式，如 `2025-01-15T00:00:00Z`
- `dateTo` (可选): 结束日期，ISO格式
- `limit` (可选): 返回数量，默认50，最大100
- `offset` (可选): 偏移量，默认0
- `sortBy` (可选): 排序字段，`weight` | `crawledAt` | `rank`，默认 `crawledAt`
- `sortOrder` (可选): 排序方向，`asc` | `desc`，默认 `desc`

**响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "clxxx...",
        "title": "新闻标题",
        "url": "https://...",
        "mobileUrl": "https://...",
        "rank": 1,
        "platform": {
          "id": "zhihu",
          "name": "知乎"
        },
        "crawledAt": "2025-01-15T10:00:00Z",
        "matches": [
          {
            "keywordGroup": {
              "id": "clxxx...",
              "name": "AI 人工智能"
            },
            "weight": 85.5,
            "matchCount": 5
          }
        ]
      }
    ],
    "total": 100,
    "limit": 50,
    "offset": 0
  }
}
```

**实现**:
```typescript
// app/api/news/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const platforms = searchParams.get('platforms')?.split(',');
  const keywordGroupId = searchParams.get('keywordGroupId');
  const minWeight = searchParams.get('minWeight') ? Number(searchParams.get('minWeight')) : undefined;
  const dateFrom = searchParams.get('dateFrom') ? new Date(searchParams.get('dateFrom')!) : undefined;
  const dateTo = searchParams.get('dateTo') ? new Date(searchParams.get('dateTo')!) : undefined;
  const limit = Math.min(Number(searchParams.get('limit') || 50), 100);
  const offset = Number(searchParams.get('offset') || 0);
  const sortBy = searchParams.get('sortBy') || 'crawledAt';
  const sortOrder = searchParams.get('sortOrder') || 'desc';

  const prisma = new PrismaClient();

  try {
    const where: any = {};

    if (platforms && platforms.length > 0) {
      where.platformId = { in: platforms };
    }

    if (dateFrom || dateTo) {
      where.crawledAt = {};
      if (dateFrom) where.crawledAt.gte = dateFrom;
      if (dateTo) where.crawledAt.lte = dateTo;
    }

    const [items, total] = await Promise.all([
      prisma.newsItem.findMany({
        where,
        include: {
          platform: true,
          matches: {
            where: keywordGroupId ? { keywordGroupId } : undefined,
            include: {
              keywordGroup: true
            },
            ...(minWeight ? { where: { weight: { gte: minWeight } } } : {})
          }
        },
        orderBy: { [sortBy]: sortOrder },
        take: limit,
        skip: offset
      }),
      prisma.newsItem.count({ where })
    ]);

    return NextResponse.json({
      success: true,
      data: {
        items,
        total,
        limit,
        offset
      }
    });
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'QUERY_ERROR',
          message: error instanceof Error ? error.message : 'Unknown error'
        }
      },
      { status: 500 }
    );
  }
}
```

### 3.2 查询新闻详情

**接口**: `GET /api/news/[id]`

**功能**: 查询单条新闻的详细信息

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "clxxx...",
    "title": "新闻标题",
    "url": "https://...",
    "mobileUrl": "https://...",
    "rank": 1,
    "platform": {
      "id": "zhihu",
      "name": "知乎"
    },
    "crawledAt": "2025-01-15T10:00:00Z",
    "matches": [
      {
        "keywordGroup": {
          "id": "clxxx...",
          "name": "AI 人工智能"
        },
        "weight": 85.5,
        "matchCount": 5,
        "firstMatchedAt": "2025-01-15T09:00:00Z",
        "lastMatchedAt": "2025-01-15T10:00:00Z"
      }
    ],
    "appearances": [
      {
        "rank": 1,
        "appearedAt": "2025-01-15T10:00:00Z"
      }
    ]
  }
}
```

---

## 4. 配置管理API

### 4.1 获取配置

**接口**: `GET /api/config`

**功能**: 获取系统配置

**查询参数**:
- `key` (可选): 配置键，不传则返回所有配置

**响应**:
```json
{
  "success": true,
  "data": {
    "crawler": {
      "request_interval": 1000,
      "enable_crawler": true,
      "use_proxy": false
    },
    "report": {
      "mode": "daily",
      "rank_threshold": 5
    },
    "notification": {
      "enable_notification": true,
      "push_window": {
        "enabled": false,
        "time_range": {
          "start": "20:00",
          "end": "22:00"
        },
        "once_per_day": true
      }
    },
    "weight": {
      "rank_weight": 0.6,
      "frequency_weight": 0.3,
      "hotness_weight": 0.1
    }
  }
}
```

### 4.2 更新配置

**接口**: `PUT /api/config`

**功能**: 更新系统配置

**请求体**:
```json
{
  "crawler": {
    "request_interval": 2000
  },
  "report": {
    "mode": "current"
  }
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "message": "配置已更新"
  }
}
```

### 4.3 关键词组管理

#### 4.3.1 获取关键词组列表

**接口**: `GET /api/config/keywords`

**响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "clxxx...",
        "name": "AI 人工智能",
        "words": ["AI", "人工智能"],
        "requiredWords": [],
        "excludedWords": [],
        "priority": 0,
        "enabled": true
      }
    ],
    "total": 10
  }
}
```

#### 4.3.2 创建关键词组

**接口**: `POST /api/config/keywords`

**请求体**:
```json
{
  "name": "AI 人工智能",
  "words": ["AI", "人工智能"],
  "requiredWords": [],
  "excludedWords": [],
  "priority": 0,
  "enabled": true
}
```

#### 4.3.3 更新关键词组

**接口**: `PUT /api/config/keywords/[id]`

**请求体**: 同创建接口

#### 4.3.4 删除关键词组

**接口**: `DELETE /api/config/keywords/[id]`

**响应**:
```json
{
  "success": true,
  "data": {
    "message": "关键词组已删除"
  }
}
```

### 4.4 平台管理

#### 4.4.1 获取平台列表

**接口**: `GET /api/config/platforms`

**响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "clxxx...",
        "platformId": "zhihu",
        "name": "知乎",
        "enabled": true
      }
    ],
    "total": 11
  }
}
```

#### 4.4.2 更新平台状态

**接口**: `PUT /api/config/platforms/[id]`

**请求体**:
```json
{
  "enabled": false
}
```

---

## 5. 通知推送API

### 5.1 发送通知

**接口**: `POST /api/notify`

**功能**: 手动触发通知推送

**请求体**:
```json
{
  "reportType": "daily", // daily | current | incremental
  "reportDate": "2025-01-15T00:00:00Z",
  "channels": ["feishu", "dingtalk"] // 可选，不传则发送到所有配置的渠道
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "success": ["feishu", "dingtalk"],
    "failed": []
  }
}
```

### 5.2 查询推送历史

**接口**: `GET /api/notify/history`

**查询参数**:
- `channel` (可选): 推送渠道
- `dateFrom` (可选): 开始日期
- `dateTo` (可选): 结束日期
- `limit` (可选): 返回数量，默认50
- `offset` (可选): 偏移量，默认0

**响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "clxxx...",
        "channel": "feishu",
        "reportType": "daily",
        "reportDate": "2025-01-15T00:00:00Z",
        "pushedAt": "2025-01-15T20:00:00Z",
        "success": true,
        "errorMessage": null
      }
    ],
    "total": 100,
    "limit": 50,
    "offset": 0
  }
}
```

---

## 6. 数据分析API

### 6.1 获取统计数据

**接口**: `GET /api/analytics`

**功能**: 获取统计数据

**查询参数**:
- `dateFrom` (可选): 开始日期
- `dateTo` (可选): 结束日期
- `keywordGroupId` (可选): 关键词组ID
- `platforms` (可选): 平台ID列表

**响应**:
```json
{
  "success": true,
  "data": {
    "totalNews": 1000,
    "matchedNews": 500,
    "matchRate": 0.5,
    "platformStats": [
      {
        "platformId": "zhihu",
        "platformName": "知乎",
        "count": 200
      }
    ],
    "keywordGroupStats": [
      {
        "keywordGroupId": "clxxx...",
        "keywordGroupName": "AI 人工智能",
        "count": 100,
        "avgWeight": 75.5
      }
    ],
    "dateRange": {
      "start": "2025-01-15T00:00:00Z",
      "end": "2025-01-15T23:59:59Z"
    }
  }
}
```

### 6.2 获取趋势数据

**接口**: `GET /api/analytics/trends`

**功能**: 获取趋势分析数据

**查询参数**:
- `keywordGroupId` (可选): 关键词组ID
- `dateFrom` (必需): 开始日期
- `dateTo` (必需): 结束日期
- `granularity` (可选): 时间粒度，`hour` | `day` | `week`，默认 `day`

**响应**:
```json
{
  "success": true,
  "data": {
    "trends": [
      {
        "date": "2025-01-15",
        "count": 50,
        "avgWeight": 75.5
      },
      {
        "date": "2025-01-16",
        "count": 60,
        "avgWeight": 80.2
      }
    ],
    "keywordGroup": {
      "id": "clxxx...",
      "name": "AI 人工智能"
    }
  }
}
```

---

## 7. Server Actions

### 7.1 使用场景

Next.js Server Actions用于表单提交和客户端交互，无需单独的API端点。

### 7.2 示例

```typescript
// app/actions/keywords.ts
'use server';

import { PrismaClient } from '@prisma/client';
import { revalidatePath } from 'next/cache';

const prisma = new PrismaClient();

export async function createKeywordGroup(formData: FormData) {
  const name = formData.get('name') as string;
  const words = (formData.get('words') as string).split('\n').filter(Boolean);

  try {
    await prisma.keywordGroup.create({
      data: {
        name,
        words,
        requiredWords: [],
        excludedWords: [],
        priority: 0,
        enabled: true
      }
    });

    revalidatePath('/settings/keywords');
    return { success: true };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}
```

---

## 8. WebSocket API (可选)

### 8.1 实时更新

如果需要实时更新功能，可以使用WebSocket或Server-Sent Events (SSE)。

**接口**: `GET /api/events`

**功能**: SSE事件流，推送实时更新

**响应**: EventStream格式

```typescript
// app/api/events/route.ts
export async function GET() {
  const stream = new ReadableStream({
    start(controller) {
      // 发送事件
      const encoder = new TextEncoder();
      controller.enqueue(
        encoder.encode(`data: ${JSON.stringify({ type: 'crawl_started' })}\n\n`)
      );
    }
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  });
}
```

---

## 相关文档

- [03-核心模块设计.md](./03-核心模块设计.md) - 核心模块设计
- [04-数据模型设计.md](./04-数据模型设计.md) - 数据模型设计
- [06-流程设计.md](./06-流程设计.md) - 业务流程设计

