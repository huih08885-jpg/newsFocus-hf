# 新闻热点聚合系统 - 流程设计

**版本**: v4.0.0  
**文档版本**: 1.0  
**最后更新**: 2025-01-XX

---

## 1. 主流程

### 1.1 系统启动流程

```
系统启动
    ↓
加载环境变量
    ↓
初始化 Prisma Client
    ↓
连接 Neon 数据库
    ↓
检查数据库迁移状态
    ↓
（可选）运行数据库迁移
    ↓
启动 Next.js 服务器
    ↓
注册定时任务（Vercel Cron）
    ↓
系统就绪
```

### 1.2 定时爬取流程

```
Vercel Cron 触发（每小时）
    ↓
调用 /api/crawl
    ↓
创建爬取任务记录
    ↓
查询所有启用的平台
    ↓
┌─────────────────────────────────────┐
│ 遍历平台列表                         │
│                                     │
│ 对于每个平台：                       │
│   1. 构建请求URL                    │
│   2. 发送HTTP请求（带重试）          │
│   3. 解析响应JSON                   │
│   4. 验证数据格式                    │
│   5. 保存到数据库                    │
│   6. 请求间隔等待                    │
└─────────────────────────────────────┘
    ↓
统计成功和失败数量
    ↓
┌─────────────────────────────────────┐
│ 关键词匹配流程                       │
│                                     │
│ 1. 查询最新爬取的新闻                │
│ 2. 获取所有启用的关键词组            │
│ 3. 遍历新闻标题                      │
│ 4. 执行关键词匹配                    │
│ 5. 创建或更新匹配记录                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 权重计算流程                         │
│                                     │
│ 1. 查询所有匹配记录                  │
│ 2. 查询新闻出现记录                  │
│ 3. 计算排名权重                      │
│ 4. 计算频次权重                      │
│ 5. 计算热度权重                      │
│ 6. 计算总权重                        │
│ 7. 更新匹配记录的权重                │
└─────────────────────────────────────┘
    ↓
更新爬取任务状态
    ↓
（可选）生成报告
    ↓
（可选）发送通知
    ↓
流程结束
```

---

## 2. 数据爬取流程

### 2.1 单个平台爬取流程

```
开始爬取平台
    ↓
构建请求URL
https://newsnow.busiyi.world/api/s?id={platformId}&latest
    ↓
发送HTTP请求
    ↓
┌──────────────────────┐
│ 请求成功？            │
└──────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
检查重试次数         解析响应JSON
    ↓                    ↓
┌──────────────┐     验证数据格式
│ 可重试？      │         ↓
└──────────────┘     提取新闻数据
    │                    ↓
   是                保存到数据库
    ↓                    ↓
等待后重试         记录成功
    ↓                    ↓
    └──────────┬─────────┘
               ↓
           流程结束
```

### 2.2 错误处理流程

```
请求失败
    ↓
记录错误信息
    ↓
┌──────────────────────┐
│ 错误类型判断          │
└──────────────────────┘
    │
    ├─ 网络错误
    │   ↓
    │  检查重试次数
    │   ↓
    │  ┌──────────────┐
    │  │ 可重试？      │
    │  └──────────────┘
    │   │
    │  是 → 等待后重试
    │   │
    │  否 → 记录失败
    │
    ├─ 解析错误
    │   ↓
    │  记录错误，跳过该平台
    │
    └─ 数据验证错误
        ↓
        记录警告，跳过无效数据
```

---

## 3. 关键词匹配流程

### 3.1 匹配算法流程

```
输入: 新闻标题
    ↓
获取所有启用的关键词组（按优先级排序）
    ↓
遍历关键词组
    ↓
┌─────────────────────────────────────┐
│ 检查普通词匹配                        │
│ - 标题包含任意一个普通词？            │
└─────────────────────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
下一个词组          ┌──────────────────────┐
                   │ 检查必须词            │
                   │ - 存在必须词？         │
                   │ - 标题包含所有必须词？ │
                   └──────────────────────┘
                       │                    │
                      否                    是
                       ↓                    ↓
                  下一个词组          ┌──────────────────────┐
                                     │ 检查过滤词            │
                                     │ - 标题包含过滤词？     │
                                     └──────────────────────┘
                                         │                    │
                                        是                    否
                                         ↓                    ↓
                                    下一个词组           匹配成功
                                                           ↓
                                                      返回匹配结果
```

### 3.2 匹配记录更新流程

```
匹配成功
    ↓
查询是否已存在匹配记录
    ↓
┌──────────────────────┐
│ 记录存在？            │
└──────────────────────┘
    │                    │
   是                    否
    ↓                    ↓
更新匹配记录         创建新匹配记录
- matchCount++      - 设置首次匹配时间
- lastMatchedAt     - 设置最后匹配时间
- 更新权重          - 计算初始权重
    ↓                    ↓
    └──────────┬─────────┘
               ↓
           保存到数据库
```

---

## 4. 权重计算流程

### 4.1 权重计算流程

```
查询匹配记录
    ↓
对于每条匹配记录：
    ↓
┌─────────────────────────────────────┐
│ 1. 查询新闻出现记录                   │
│    - 获取所有排名记录                 │
│    - 获取出现时间范围                 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 计算排名权重                       │
│    rank_score = Σ(11 - min(rank, 10)) / 出现次数 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 计算频次权重                       │
│    frequency_score = min(出现次数, 10) × 10 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 4. 计算热度权重                       │
│    hotness_score = (高排名次数 / 总出现次数) × 100 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 5. 计算总权重                         │
│    total_weight = rank_score × 0.6 + │
│                  frequency_score × 0.3 + │
│                  hotness_score × 0.1 │
└─────────────────────────────────────┘
    ↓
更新匹配记录的权重字段
    ↓
下一个匹配记录
```

### 4.2 增量检测流程

```
查询最新爬取的新闻
    ↓
查询历史匹配记录
    ↓
对比差异
    ↓
┌─────────────────────────────────────┐
│ 标记新增新闻                          │
│ - 首次出现的新闻标记为 isNew = true  │
│ - 已存在的新闻标记为 isNew = false   │
└─────────────────────────────────────┘
    ↓
更新匹配记录
    ↓
流程结束
```

---

## 5. 报告生成流程

### 5.1 HTML报告生成流程

```
获取报告数据
    ↓
┌─────────────────────────────────────┐
│ 1. 准备报告数据                       │
│    - 查询匹配的新闻                   │
│    - 按关键词组分组                    │
│    - 计算统计数据                      │
│    - 标记新增新闻                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 生成HTML内容                       │
│    - 渲染头部信息                     │
│    - 渲染统计数据                     │
│    - 渲染新闻列表                     │
│    - 渲染新增新闻区域                  │
│    - 应用样式                          │
└─────────────────────────────────────┘
    ↓
保存HTML文件（可选，存储到Vercel Blob）
    ↓
返回HTML内容
```

### 5.2 消息格式化流程

```
获取报告数据
    ↓
选择消息格式（feishu/dingtalk/wework/telegram/email/ntfy）
    ↓
┌─────────────────────────────────────┐
│ 格式化消息内容                        │
│ - 根据渠道格式要求格式化               │
│ - 添加链接和样式                      │
│ - 处理特殊字符                        │
└─────────────────────────────────────┘
    ↓
检查消息长度
    ↓
┌──────────────────────┐
│ 超过限制？            │
└──────────────────────┘
    │                    │
   是                    否
    ↓                    ↓
分批处理            直接返回
    ↓                    ↓
    └──────────┬─────────┘
               ↓
           返回消息
```

---

## 6. 通知推送流程

### 6.1 推送主流程

```
触发推送（定时任务或手动）
    ↓
┌─────────────────────────────────────┐
│ 1. 检查推送时间窗口                   │
│    - 获取当前时间                      │
│    - 检查是否在时间窗口内               │
└─────────────────────────────────────┘
    ↓
┌──────────────────────┐
│ 在时间窗口内？        │
└──────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
跳过推送          ┌──────────────────────┐
                 │ 2. 检查推送记录        │
                 │    - 查询今天的推送记录  │
                 │    - 检查是否已推送     │
                 └──────────────────────┘
                     │                    │
                    是                    否
                     ↓                    ↓
                跳过推送          ┌──────────────────────┐
                                 │ 3. 生成报告数据        │
                                 │    - 查询匹配新闻       │
                                 │    - 计算统计数据       │
                                 │    - 生成报告内容       │
                                 └──────────────────────┘
                                     ↓
                                 ┌──────────────────────┐
                                 │ 4. 格式化消息          │
                                 │    - 根据渠道格式化     │
                                 │    - 分批处理（如需要） │
                                 └──────────────────────┘
                                     ↓
                                 ┌──────────────────────┐
                                 │ 5. 发送到各渠道        │
                                 │    - 遍历配置的渠道     │
                                 │    - 调用推送接口       │
                                 │    - 记录推送结果       │
                                 └──────────────────────┘
                                     ↓
                                 ┌──────────────────────┐
                                 │ 6. 记录推送状态        │
                                 │    - 保存推送记录       │
                                 │    - 更新推送状态       │
                                 └──────────────────────┘
                                     ↓
                                 流程结束
```

### 6.2 分批推送流程

```
消息内容
    ↓
检查消息长度
    ↓
┌──────────────────────┐
│ 超过限制？            │
└──────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
直接发送          ┌──────────────────────┐
                 │ 按词组分割消息        │
                 │ - 保持消息完整性       │
                 │ - 添加分隔符          │
                 └──────────────────────┘
                     ↓
                 分割为多个批次
                     ↓
                 遍历批次
                     ↓
                 ┌──────────────────────┐
                 │ 发送批次              │
                 │ - 调用推送接口        │
                 │ - 等待间隔（3秒）     │
                 └──────────────────────┘
                     ↓
                 下一个批次
                     ↓
                 所有批次发送完成
```

---

## 7. Web界面流程

### 7.1 页面加载流程

```
用户访问页面
    ↓
Next.js Server Component
    ↓
查询数据库
    ↓
（可选）检查缓存
    ↓
┌──────────────────────┐
│ 缓存命中？            │
└──────────────────────┘
    │                    │
   是                    否
    ↓                    ↓
返回缓存数据        查询数据库
    ↓                    ↓
    └──────────┬─────────┘
               ↓
        渲染HTML
               ↓
        发送到客户端
               ↓
        客户端水合（Hydration）
               ↓
        页面可交互
```

### 7.2 数据查询流程

```
用户触发查询（筛选/搜索）
    ↓
客户端发送请求
    ↓
Next.js API Route
    ↓
解析查询参数
    ↓
构建Prisma查询
    ↓
执行数据库查询
    ↓
（可选）缓存结果
    ↓
返回JSON数据
    ↓
客户端更新UI
```

### 7.3 配置更新流程

```
用户在设置页面修改配置
    ↓
提交表单
    ↓
调用 Server Action 或 API
    ↓
验证数据
    ↓
┌──────────────────────┐
│ 验证通过？            │
└──────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
返回错误         更新数据库
    ↓                    ↓
显示错误消息     清除相关缓存
    ↓                    ↓
                重新验证路径
    ↓                    ↓
                返回成功
    ↓                    ↓
                更新UI
```

---

## 8. 定时任务流程

### 8.1 Vercel Cron配置

```typescript
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/crawl",
      "schedule": "0 * * * *" // 每小时执行
    },
    {
      "path": "/api/cron/cleanup",
      "schedule": "0 2 * * *" // 每天凌晨2点执行
    }
  ]
}
```

### 8.2 爬取定时任务流程

```
Vercel Cron触发
    ↓
调用 /api/cron/crawl
    ↓
验证Cron Secret（安全验证）
    ↓
执行爬取流程
    ↓
记录执行日志
    ↓
返回执行结果
```

### 8.3 数据清理定时任务流程

```
Vercel Cron触发（每天凌晨2点）
    ↓
调用 /api/cron/cleanup
    ↓
┌─────────────────────────────────────┐
│ 1. 清理旧数据                         │
│    - 删除30天前的新闻数据             │
│    - 删除30天前的匹配记录             │
│    - 删除30天前的出现记录             │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 清理推送记录                       │
│    - 删除超过保留期的推送记录         │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 清理旧文件                         │
│    - 删除Vercel Blob中的旧报告文件    │
└─────────────────────────────────────┘
    ↓
记录清理日志
    ↓
返回清理结果
```

---

## 9. 错误处理流程

### 9.1 全局错误处理

```
发生错误
    ↓
捕获错误
    ↓
┌─────────────────────────────────────┐
│ 错误分类                              │
│ - 网络错误                            │
│ - 数据库错误                          │
│ - 业务逻辑错误                        │
│ - 系统错误                            │
└─────────────────────────────────────┘
    ↓
记录错误日志
    ↓
┌─────────────────────────────────────┐
│ 错误处理策略                          │
│ - 可重试错误：等待后重试               │
│ - 不可重试错误：记录并跳过             │
│ - 严重错误：通知管理员                 │
└─────────────────────────────────────┘
    ↓
返回错误响应
```

### 9.2 重试机制流程

```
操作失败
    ↓
检查重试次数
    ↓
┌──────────────────────┐
│ 可重试？              │
└──────────────────────┘
    │                    │
   否                    是
    ↓                    ↓
记录失败         计算重试延迟
    ↓                    ↓
返回错误         等待延迟时间
    ↓                    ↓
                重试操作
    ↓                    ↓
            ┌────────────┘
            │
            ↓
        检查结果
```

---

## 相关文档

- [03-核心模块设计.md](./03-核心模块设计.md) - 核心模块设计
- [05-接口设计.md](./05-接口设计.md) - API接口设计
- [07-部署架构.md](./07-部署架构.md) - 部署架构

